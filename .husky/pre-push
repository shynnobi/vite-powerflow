#!/bin/sh

# Read all refs from stdin into a variable
refs=$(cat)

run_validation=false

if [ -z "$refs" ]; then
  # No refs to push: likely a remote branch deletion
  echo "‚è© Skipping validation for remote branch deletion (no refs to push)."
  exit 0
fi

# Otherwise, check if any ref is not a deletion
printf '%s\n' "$refs" | while read local_ref local_sha remote_ref remote_sha; do
  if [ "$remote_sha" != "0000000000000000000000000000000000000000" ]; then
    run_validation=true
  fi
done

# Check scripts/ TypeScript quality only if scripts have changed
changed_scripts=$(git diff --cached --name-only | grep '^scripts/.*\.ts$' || true)
if [ -n "$changed_scripts" ]; then
  echo "üîé Checking root scripts quality before push..."
  pnpm run root-scripts:static || {
    echo "‚ùå Scripts quality check failed."
    exit 1
  }
fi

if [ "$run_validation" = true ]; then
  echo "üß™ Running full validation before push..."

  # Run all validations including E2E tests
  pnpm validate:full || {
    echo "‚ùå Validation failed."
    exit 1
  }

  echo "‚úÖ All checks passed. Proceeding with push..."
else
  echo "‚è© Skipping validation for remote branch deletion."
fi
